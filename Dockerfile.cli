# happy-cli: build and run the CLI in a container
# Usage:
#   docker compose run --rm cli <command>
#   docker compose run --rm cli auth
#   docker compose run --rm cli daemon status

# Stage 1: install dependencies
FROM node:20 AS deps

RUN apt-get update && apt-get install -y python3 make g++ build-essential && rm -rf /var/lib/apt/lists/*

WORKDIR /repo

COPY package.json yarn.lock ./
COPY scripts ./scripts

RUN mkdir -p packages/happy-app packages/happy-server packages/happy-cli packages/happy-agent packages/happy-wire

COPY packages/happy-app/package.json packages/happy-app/
COPY packages/happy-server/package.json packages/happy-server/
COPY packages/happy-cli/package.json packages/happy-cli/
COPY packages/happy-agent/package.json packages/happy-agent/
COPY packages/happy-wire/package.json packages/happy-wire/

# Workspace postinstall requirements
COPY packages/happy-app/patches packages/happy-app/patches
COPY packages/happy-server/prisma packages/happy-server/prisma
COPY packages/happy-cli/scripts packages/happy-cli/scripts
COPY packages/happy-cli/tools packages/happy-cli/tools

RUN SKIP_HAPPY_WIRE_BUILD=1 yarn install --frozen-lockfile --ignore-engines

# Stage 2: build happy-wire and happy-cli
FROM deps AS builder

COPY packages/happy-wire ./packages/happy-wire
COPY packages/happy-cli ./packages/happy-cli

RUN yarn workspace @slopus/happy-wire build
# Skip typecheck (upstream has a TS error in runAcp.ts), just bundle
RUN cd packages/happy-cli && npx shx rm -rf dist && npx pkgroll

# Stage 3: runtime
FROM node:20-slim AS runner

RUN apt-get update && apt-get install -y tini git && rm -rf /var/lib/apt/lists/*

WORKDIR /repo

ENV NODE_ENV=production
ENV HAPPY_HOME_DIR=/data/.happy

# Install Claude Code CLI globally
RUN npm install -g @anthropic-ai/claude-code

COPY --from=builder /repo/node_modules /repo/node_modules
COPY --from=builder /repo/packages/happy-wire /repo/packages/happy-wire
COPY --from=builder /repo/packages/happy-cli /repo/packages/happy-cli

# Install happy CLI via npm link so `happy` is on PATH
RUN cd packages/happy-cli && npm link

# Run as non-root user (Claude Code refuses --dangerously-skip-permissions as root)
RUN mkdir -p /data /workspace && \
    chown -R node:node /data /workspace
USER node

ENTRYPOINT ["tini", "--", "bash", "-c"]
CMD ["happy"]
